# 八字排盘引擎设计方案

## 1. 技术栈与标准

*   **命理标准**：以《渊海子平》为核心逻辑（强调月令定格、五行生克）。
*   **核心库**：`lunar_python` (基础干支计算、藏干、十神、大运)
*   **辅助库**：`pytz` (处理时区与获取当前时间)
*   **本地数据**：`latlng.json` (经纬度数据，用于真太阳时校正)
---

## 2. 输入信息 (Input)

| 参数名 | 类型 | 必填 | 输入方式 | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| `name` | String | 是 | 文本输入 | 姓名 |
| `gender` | Integer | 是 | 单选 | 性别：1 为男 (默认)，0 为女 |
| `calendar_type` | Enum | 是 | 单选/分段控制 | 历法：`SOLAR` (公历) 或 `LUNAR` (农历，默认) |
| `birth_datetime` | DateTime | 是 | 日期时间选择器 | 出生公历/农历时间 |
| `birth_location` | String | 是 | 地区选择器 | 用于检索 `latlng.json` 获取经度 |
| `time_mode` | Enum | 是 | 单选 | 时间标准：`TRUE_SOLAR` (真太阳时，默认) 或 `MEAN_SOLAR` (平太阳时) |
| `month_mode` | Enum | 是 | 单选 | 月柱标准：`SOLAR_TERM` (节气定月，默认) 或 `LUNAR_MONTH` (农历月定月) |
| `zi_shi_mode` | Enum | 是 | 单选 | 子时模式：`LATE_ZI_IN_DAY` (晚子时不换日，默认) 或 `NEXT_DAY` (23点换日) |

---

## 3. 排盘内容规则算法

明确排盘各项指标的生成顺序、数据来源及核心规则。

| 内容分类 | 具体项目 | 来源 | 规则/算法简述 |
| :--- | :--- | :--- | :--- |
| **0. 预处理阶段** | 请求环境记录 | `pytz` | 记录系统时间、**原始输入参数快照**及算法逻辑开关配置 |
| | 夏令时判定 | `pytz` | 自动处理 1986-1991 夏令时政策，校正 1 小时偏移 |
| | 真太阳时校正 | 自研 | 依据 `latlng.json` 经度与均时差 (EoT) 修正平太阳时，生成基准时间 |
| | 子时处理逻辑 | 自研 | **依据 `zi_shi_mode` 开关调用 `eight_char.setSect(1/2)`** 控制 23 点换日 |
| | 月柱判定逻辑 | `lunar_python` | **`month_mode`**: `Exact` 系列方法对应节气定月，非 `Exact` 对应农历月 |
| | 节气上下文 | `lunar_python` | `lunar.getPrevJie()` / `getNextJie()` 获取出生前后节气精确时刻 |
| **1. 核心命盘** | 四柱八字 | `lunar_python` | `eight_char.getYear/Month/Day/Time()` 获取干支字符串 |
| | 十神 (Ten Gods) | `lunar_python` | `eight_char.getXXXShiShenGan()` / `getXXXShiShenZhi()` |
| | 地支藏干 | `lunar_python` | `eight_char.getXXXHideGan()` 返回主气、中气、余气列表 |
| | 纳音五行 | `lunar_python` | `eight_char.getXXXNaYin()` 返回柱对应的纳音名称 |
| | 空亡 (Void) | `lunar_python` | `eight_char.getYearXunKong()` / `getDayXunKong()` 获取旬空地支 |
| **2. 动态运程** | 起运时间 | `lunar_python` | `yun.getStartSolar()` 获取精确到时辰的起运阳历时间 |
| | 大运 (Great Luck) | `lunar_python` | `yun.getDaYun()` 获取包含干支、起止年龄及年份的大运列表 |
| | 流年/流月/流日 | `lunar_python` | `da_yun.getLiuNian()` -> `liu_nian.getLiuYue()` 逐级获取 |
| | 小运 (Minor) | `lunar_python` | `da_yun.getXiaoYun()` 获取各阶段小运，支持起运前（Index 0） |
| **3. 辅助命盘** | 十二长生 | lunar_python | eight_char.getXXXDiShi() 获取各柱地势（如：长生、帝旺） |
| | 胎元 | lunar_python | eight_char.getTaiYuan() 及 `getTaiYuanNaYin()` |
| | 命宫 | lunar_python | eight_char.getMingGong() 及 `getMingGongNaYin()` |
| | 身宫 | lunar_python | eight_char.getShenGong() 及 `getShenGongNaYin()` |
| **4. 深度指标** | **月令分司 (司令)** | 自研 | **基于库提供的节气时刻**，映射人元司令分野计算司权天干 |
| | 五行旺衰分值 | 自研 | 位置权重（月令 2.5x）+ 通根系数（3x/1.5x）量化评分 |
| | 日主强弱 | 自研 | 基于量化评分判定：身强、身弱、从格或中和 |
| | 格局判定 | 自研 | 依据《渊海子平》月令透干定格，包含正格与外格 |
| | 喜用神 | 自研 | 依据平衡、调候、通关原则判定：用神、喜神、忌神、仇神 |
| | 干支作用关系 | 自研 | 识别四柱及岁运间的合、冲、刑、害、破、会 |
| | 神煞系统 | 自研 | 包含天乙、文昌、桃花、羊刃、魁罡、天德/月德等（库中未直接提供八字神煞） |

---

## 4. 自研算法说明 (基于《渊海子平》标准)

针对 `lunar_python` 无法覆盖的核心命理逻辑，需自研以下算法模块：

### 4.1. 真太阳时校正 (Physical Correction)
*   **平太阳时 (LMT)**：`LMT = UTC + (Longitude / 15)`。
*   **均时差 (EoT)**：采用简化天文公式：`EoT = 9.87*sin(2B) - 7.67*sin(B+78.7)`，其中 `B = 360*(N-81)/365`。
*   **真太阳时**：`True_Solar_Time = LMT + EoT`。
    *   *注：需从 `latlng.json` 获取出生地经度。*

### 4.2. 子时处理逻辑 (Zi-Shi Strategy)
*   **早子时 (00:00-01:00)**：日柱使用“本日”干支，时柱为“子时”。
*   **晚子时 (23:00-24:00)**：日柱使用“本日”干支（不进位），时柱为“子时”，但在计算大运时需视为跨日临界。
    *   *标准：默认提供开关，若开启“早晚子时”，23点后不更幻日柱天干，仅更幻时柱。*

### 4.3. 地支作用与动态合化校验 (Dynamic Interaction)
用 **“合化校验算子”** 逻辑：
*   **触发检测**：识别四柱中的合、会、冲、刑、害、破信号。
*   **合化校验 (Transformation Validator)**：
    *   **天干引化**：检查合化之五行是否在天干透出。
    *   **月令支持**：校验月令是否为合化五行之旺地。
    *   **邻近原则**：判定相互作用的紧密度（如：日时支合 > 年时支隔合）。
*   **结果反馈**：只有校验通过，才修改底层五行能量分布；否则仅计为“合而不化”。

### 4.4. 月令分司用事 (Divided Command)
根据《渊海子平·人元司令分野》计算月令深浅：
*   **算法**：计算出生时间距离上一个“节”的精确分钟数，映射对应的司令天干。
    *   例：寅月（立春后）：戊土用事7日，丙火用事7日，甲木用事16日。

### 4.5. 五行评分模型 (Exponential Scoring)
用 **“基础值 × 位置权重 × 通根系数”**：
*   **位置权重**：月令（提纲）权重设为 2.5~3.0，日支 1.5，年时支 1.0。
*   **通根系数 (Rooting Factor)**：
    *   **透干得根**：若天干在地支有本气根，其力量提升 3 倍；中余气根提升 1.5 倍。
    *   **虚浮判定**：无根天干视为“虚浮”，力量缩减 50%。
*   **减分项**：受冲、受克、被合（化神非本气）时，按比例削减分值。

### 4.6. 格局判定策略 (Pattern Strategy)
引入 **策略模式 (Strategy Pattern)** 应对复杂判定逻辑：
1.  **取格优先级**：月令本气透干 > 月令所藏中余气透干 > 月令本气。
2.  **外格专项策略**：为“飞天禄马”、“井栏叉”等特殊格局编写独立校验器，处理：
    *   **虚神校验**：检查特定地支的数量（如子字多寡）。
    *   **破格检查**：自动检索是否存在“填实”、“冲破”等败格条件。
3.  **判定链**：外格专项校验 -> 变格（从、化）判定 -> 八格判定。

### 4.7. 日主强弱判定 (Daymaster Strength)
1.  **判定维度**：
    *   **得令**：日干在月令的五行状态（旺相休囚死）。
    *   **得地**：日干在四柱地支是否有根（本气根、中余气根）。
    *   **得生/得助**：四柱中印绶与比劫的整体能量占比。
2.  **量化判定标准**：基于 4.5 节的五行评分模型，将日主得分与全局得分进行对比，划分为：身强（偏强/极强）、身弱（偏弱/极弱）、中和、从格（从强/从弱）。

### 4.8. 喜用神推导分析 (Useful God)
1.  **核心原则**：
    *   **抑强扶弱（平衡）**：身强喜克泄耗，身弱喜生扶。
    *   **调候为急**：针对冬生（严寒）需火调候，夏生（酷暑）需水调候，优先级有时高于平衡。
    *   **通关为用**：针对两神对峙（如金木交战）的情况，取水通关。
2.  **推导逻辑**：依据上述原则，从五行中选定“用神、喜神”，并对应确定“忌神、仇神”。

### 4.9. 八字神煞系统 (Shen-Sha System)
*   **计算维度**：
    *   **以日干为主**：推算天乙贵人、文昌贵人、羊刃、红艳、截路空亡等。
    *   **以月令为主**：推算天德贵人、月德贵人、天医等。
    *   **以日支/年支为主**：推算驿马、桃花、华盖、劫煞、亡神等。
*   **特殊组合特征检测**：
    *   **魁罡格**：检测日柱是否为“壬辰、庚戌、庚辰、戊戌”。
    *   **金神格**：检测时柱是否为“乙丑、己巳、癸酉”。
*   **实现方式**：构建 `StarDetector` 映射表，对四柱及动态岁运进行特征扫描匹配，支持多维度神煞权重叠加。

### 4.10. 夏令时（DST）说明 (Daylight Saving Time)
*   **DST 灾难**：中国在 1986-1991 年实行过夏令时（夏令时出生的人，若不减去 1 小时，时柱可能完全错误）。
*   **处理方案**：`pytz` 支持大部分 DST，但需要确保输入时间是“墙上时间（Wall Clock Time）”且正确匹配了当年的 DST 规则。

---

## 5. 质量保证：古籍锚点测试 (Bible Benchmark)

为了验证算法的“命理灵魂”，必须通过以下自动化测试：
*   **测试数据集**：以《千里命稿》中 100+ 个经典案例为标准 Unit Test。
*   **验收指标**：
    *   **格局判定一致率 > 90%**。
    *   **身强身弱判定与古籍结论完全一致**。
    *   **喜用神推导偏差不超过一个层级**。
*   **回归机制**：每次修改评分权重或合化算法后，必须重新运行全量古籍测试集。

---

## 6. 输出数据 (Output JSON 结构)

```json
{
  "preprocessing": {
    "request_info": {
      "current_system_time": "2024-01-03 15:30:00",
      "input_params": {
        "name": "张三",
        "gender": 1,
        "calendar_type": "SOLAR",
        "birth_datetime": "1990-01-01 12:00:00",
        "birth_location": "北京",
        "time_mode": "TRUE_SOLAR",
        "month_mode": "SOLAR_TERM",
        "zi_shi_mode": "LATE_ZI_IN_DAY"
      }
    },
    "time_correction": {
      "longitude": 116.4,
      "lon_offset_minutes": -14.4,
      "eot_minutes": -3.2,
      "dst_offset_minutes": 0,
      "lmt_time": "1990-01-01 11:45:36",
      "true_solar_datetime": "1990-01-01 11:42:24",
      "is_late_zi_shi": false
    },
    "solar_term_context": {
      "prev_term": {"name": "冬至", "time": "1989-12-22 05:22:00"},
      "next_term": {"name": "小寒", "time": "1990-01-05 21:15:00"},
      "offset_from_prev": "10天6小时20分",
      "distance_to_next_minutes": 6332
    }
  },
  "chart_data": {
    "basic": {
      "lunar_date": "农历一九八九年十二月初五",
      "zodiac": "蛇",
      "pillars": {
        "year": {
          "gz": "己巳", "ss": "伤官", "ny": "大林木", "cs": "沐浴",
          "cg": [{"gan": "丙", "ss": "比肩", "is_main": true}, {"gan": "庚", "ss": "偏财"}, {"gan": "戊", "ss": "食神"}]
        },
        "month": {
          "gz": "丙子", "ss": "比肩", "ny": "涧下水", "cs": "胎",
          "cg": [{"gan": "癸", "ss": "正官", "is_main": true}]
        },
        "day": {
          "gz": "丙寅", "ss": "日主", "ny": "炉中火", "cs": "长生",
          "cg": [{"gan": "甲", "ss": "偏印", "is_main": true}, {"gan": "丙", "ss": "比肩"}, {"gan": "戊", "ss": "食神"}]
        },
        "time": {
          "gz": "甲午", "ss": "偏印", "ny": "沙中金", "cs": "帝旺",
          "cg": [{"gan": "丁", "ss": "劫财", "is_main": true}, {"gan": "己", "ss": "伤官"}]
        }
      },
      "void": {"day_void": ["戌", "亥"], "year_void": ["午", "未"]},
      "auxiliary_pillars": {
        "tai_yuan": {"gz": "丁卯", "ny": "炉中火"},
        "ming_gong": {"gz": "己巳", "ny": "大林木"},
        "shen_gong": {"gz": "乙亥", "ny": "山头火"}
      }
    },
    "deep_analysis": {
      "month_command": {
        "current": "丙火",
        "days_passed": 10,
        "split_table": "戊土7天, 丙火7天, 甲木16天",
        "desc": "处于丙火司权第3天"
      },
      "ge_ju": "偏印格",
      "five_elements": {
        "scores": {"metal": 10, "wood": 30, "water": 5, "fire": 45, "earth": 10},
        "status": "火旺土焦"
      },
      "strength": {"level": "身强", "score": 65, "desc": "偏强，喜克泄耗"},
      "useful_god": {"yong": "水", "xi": "金", "ji": "木", "chou": "火"},
      "interactions": {
        "stems": [{"type": "合", "source": "年干", "target": "时干", "desc": "甲己合化土"}],
        "branches": [{"type": "六合", "pos": ["日支", "月支"], "desc": "寅亥合木"}]
      },
      "stars": [
        {"name": "天乙贵人", "pos": "年支", "desc": "逢凶化吉"},
        {"name": "文昌贵人", "pos": "时支", "desc": "利学业" }
      ]
    },
    "fortune": {
      "start_at": {"age": 7, "date": "1997-04-15", "desc": "7岁3个月5天起运"},
      "da_yun": [
        {
          "index": 1, "age_range": "7-17", "gz": "乙亥", "ss": "正印", "cs": "绝",
          "liu_nian": [
            {
              "year": 1997, "gz": "丁丑", "ss": "劫财", 
              "liu_yue": [{"month": 1, "gz": "壬寅", "ss": "七杀"}]
            }
          ]
        }
      ],
      "xiao_yun": [{"year": 1990, "gz": "庚辰", "ss": "偏印"}]
    }
  }
}
```

---

### 6.1. 可视化输出示例 (UI/CLI Reference)

为了提升用户体验，除 JSON 外，引擎逻辑应能支撑如下形式的可视化排盘（以张三案例为例）：

```text
姓名：张三    性别：男    出生地：北京
公历：1990年01月01日 12:00:00 (月令节气定月)
农历：一九八九年腊月初五日
真太阳时：1990-01-01 11:42:24 (均时差：-3.2分，经度：116.4°)

       年柱 (岁)      月柱 (提纲)     日柱 (日主)     时柱 (帝座)
十神     伤官           比肩           日元           偏印
干支     己巳           丙子           丙寅           甲午
藏干   丙 庚 戊          癸          甲 丙 戊         丁 己
十神   比 财 食          官          枭 比 食         劫 伤
纳音    大林木         涧下水         炉中火         沙中金
长生     沐浴           胎            长生           帝旺
空亡     戌亥           申酉           戌亥           辰巳

[命理简评]
--------------------------------------------------------------------------------
格局：偏印格 (月令癸水透出)
月令：处于丙火司权第3天 (丙火用事)
身强：身强 (65分)
喜用：用神 [水], 喜神 [金], 忌神 [木], 仇神 [火]
--------------------------------------------------------------------------------

[大运程] (7岁3个月5天起运)
--------------------------------------------------------------------------------
起运：1997年04月15日
[07-16] 乙亥 (正印/绝)
[17-26] 甲戌 (偏印/墓)
[27-36] 癸酉 (正官/死)
...
--------------------------------------------------------------------------------
```
